<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promises & Promise Chaining Examples - Level 5</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .example {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .example h3 {
            color: #333;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .output {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <h1>Promises & Promise Chaining Examples - Level 5</h1>
    <p>These examples demonstrate Promise fundamentals and chaining patterns.</p>

    <!-- Example 1: Basic Promises -->
    <div class="example">
        <h3>1. Basic Promise Creation and Usage</h3>
        <p>This example shows how to create and use basic Promises.</p>
        
        <div class="code-block">
            <pre><code>// Creating a Promise
const promise = new Promise((resolve, reject) => {
    setTimeout(() => {
        const success = Math.random() > 0.5;
        if (success) {
            resolve('Promise resolved successfully!');
        } else {
            reject(new Error('Promise rejected!'));
        }
    }, 1000);
});

// Using the Promise
promise
    .then(result => console.log('Success:', result))
    .catch(error => console.log('Error:', error.message))
    .finally(() => console.log('Promise completed'));</code></pre>
        </div>
        
        <button onclick="runBasicPromises()">Run Example</button>
        <div id="basicPromisesOutput" class="output"></div>
    </div>

    <!-- Example 2: Promise Chaining -->
    <div class="example">
        <h3>2. Promise Chaining</h3>
        <p>This example demonstrates how to chain multiple Promises together.</p>
        
        <div class="code-block">
            <pre><code>// Promise chaining example
function fetchUser(id) {
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve({ id, name: `User ${id}`, email: `user${id}@example.com` });
        }, 500);
    });
}

function fetchPosts(userId) {
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve([
                { id: 1, userId, title: 'Post 1' },
                { id: 2, userId, title: 'Post 2' }
            ]);
        }, 300);
    });
}

function fetchComments(postId) {
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve([
                { id: 1, postId, text: 'Comment 1' },
                { id: 2, postId, text: 'Comment 2' }
            ]);
        }, 200);
    });
}

// Chain the Promises
fetchUser(1)
    .then(user => {
        console.log('User:', user);
        return fetchPosts(user.id);
    })
    .then(posts => {
        console.log('Posts:', posts);
        return fetchComments(posts[0].id);
    })
    .then(comments => {
        console.log('Comments:', comments);
    })
    .catch(error => {
        console.log('Error:', error.message);
    });</code></pre>
        </div>
        
        <button onclick="runPromiseChaining()">Run Example</button>
        <div id="promiseChainingOutput" class="output"></div>
    </div>

    <!-- Example 3: Promise.all -->
    <div class="example">
        <h3>3. Promise.all - Parallel Execution</h3>
        <p>This example shows how to execute multiple Promises in parallel.</p>
        
        <div class="code-block">
            <pre><code>// Parallel execution with Promise.all
function fetchData(url) {
    return new Promise((resolve) => {
        const delay = Math.random() * 2000 + 500;
        setTimeout(() => {
            resolve({ url, data: `Data from ${url}`, delay });
        }, delay);
    });
}

const urls = [
    'https://api.example.com/users',
    'https://api.example.com/posts',
    'https://api.example.com/comments'
];

// Execute all Promises in parallel
Promise.all(urls.map(url => fetchData(url)))
    .then(results => {
        console.log('All data fetched:', results);
        console.log('Total time:', Math.max(...results.map(r => r.delay)));
    })
    .catch(error => {
        console.log('Error:', error.message);
    });</code></pre>
        </div>
        
        <button onclick="runPromiseAll()">Run Example</button>
        <div id="promiseAllOutput" class="output"></div>
    </div>

    <!-- Example 4: Promise.race -->
    <div class="example">
        <h3>4. Promise.race - First to Complete</h3>
        <p>This example demonstrates Promise.race for getting the first resolved Promise.</p>
        
        <div class="code-block">
            <pre><code>// Promise.race example
function timeoutPromise(ms) {
    return new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Timeout')), ms);
    });
}

function fetchWithTimeout(url, timeout = 2000) {
    return Promise.race([
        fetchData(url),
        timeoutPromise(timeout)
    ]);
}

// Test with different timeouts
const promises = [
    fetchWithTimeout('https://api.example.com/slow', 1000),
    fetchWithTimeout('https://api.example.com/fast', 2000),
    fetchWithTimeout('https://api.example.com/medium', 1500)
];

Promise.race(promises)
    .then(result => {
        console.log('First to complete:', result);
    })
    .catch(error => {
        console.log('All failed or timeout:', error.message);
    });</code></pre>
        </div>
        
        <button onclick="runPromiseRace()">Run Example</button>
        <div id="promiseRaceOutput" class="output"></div>
    </div>

    <!-- Example 5: Promise.allSettled -->
    <div class="example">
        <h3>5. Promise.allSettled - Wait for All</h3>
        <p>This example shows Promise.allSettled which waits for all Promises to settle.</p>
        
        <div class="code-block">
            <pre><code>// Promise.allSettled example
function fetchDataWithRandomFailure(url) {
    return new Promise((resolve, reject) => {
        const delay = Math.random() * 1000 + 500;
        setTimeout(() => {
            if (Math.random() < 0.3) {
                reject(new Error(`Failed to fetch ${url}`));
            } else {
                resolve({ url, data: `Data from ${url}` });
            }
        }, delay);
    });
}

const urls = [
    'https://api.example.com/users',
    'https://api.example.com/posts',
    'https://api.example.com/comments',
    'https://api.example.com/settings'
];

Promise.allSettled(urls.map(url => fetchDataWithRandomFailure(url)))
    .then(results => {
        console.log('All Promises settled:');
        results.forEach((result, index) => {
            if (result.status === 'fulfilled') {
                console.log(`✓ ${urls[index]}:`, result.value);
            } else {
                console.log(`✗ ${urls[index]}:`, result.reason.message);
            }
        });
    });</code></pre>
        </div>
        
        <button onclick="runPromiseAllSettled()">Run Example</button>
        <div id="promiseAllSettledOutput" class="output"></div>
    </div>

    <!-- Example 6: Promise Error Handling -->
    <div class="example">
        <h3>6. Promise Error Handling</h3>
        <p>This example demonstrates different error handling patterns with Promises.</p>
        
        <div class="code-block">
            <pre><code>// Error handling patterns
function fetchUserData(userId) {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            if (userId < 0) {
                reject(new Error('Invalid user ID'));
            } else if (userId === 0) {
                reject(new Error('User not found'));
            } else {
                resolve({ id: userId, name: `User ${userId}` });
            }
        }, 500);
    });
}

// Error handling with catch
fetchUserData(1)
    .then(user => {
        console.log('User found:', user);
        return fetchUserData(user.id + 10);
    })
    .then(user => {
        console.log('Related user:', user);
    })
    .catch(error => {
        console.log('Error caught:', error.message);
    });

// Error handling with individual catch
fetchUserData(-1)
    .then(user => {
        console.log('This will not execute');
    })
    .catch(error => {
        console.log('Specific error:', error.message);
        return { id: 0, name: 'Default User' };
    })
    .then(user => {
        console.log('Fallback user:', user);
    });</code></pre>
        </div>
        
        <button onclick="runPromiseErrorHandling()">Run Example</button>
        <div id="promiseErrorHandlingOutput" class="output"></div>
    </div>

    <!-- Example 7: Promise Utilities -->
    <div class="example">
        <h3>7. Promise Utilities and Helpers</h3>
        <p>This example shows useful Promise utilities and helper functions.</p>
        
        <div class="code-block">
            <pre><code>// Promise utilities
class PromiseUtils {
    // Delay utility
    static delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Retry utility
    static retry(fn, maxRetries = 3, delay = 1000) {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            
            const attempt = () => {
                attempts++;
                fn()
                    .then(resolve)
                    .catch(error => {
                        if (attempts < maxRetries) {
                            console.log(`Attempt ${attempts} failed, retrying...`);
                            setTimeout(attempt, delay * attempts);
                        } else {
                            reject(error);
                        }
                    });
            };
            
            attempt();
        });
    }
    
    // Timeout utility
    static timeout(promise, ms) {
        return Promise.race([
            promise,
            new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Operation timeout')), ms)
            )
        ]);
    }
    
    // Sequential execution
    static sequence(promises) {
        return promises.reduce((chain, promise) => {
            return chain.then(() => promise);
        }, Promise.resolve());
    }
    
    // Batch execution
    static batch(promises, batchSize = 3) {
        const batches = [];
        for (let i = 0; i < promises.length; i += batchSize) {
            batches.push(promises.slice(i, i + batchSize));
        }
        
        return batches.reduce((chain, batch) => {
            return chain.then(() => Promise.all(batch));
        }, Promise.resolve());
    }
}</code></pre>
        </div>
        
        <button onclick="runPromiseUtilities()">Run Example</button>
        <div id="promiseUtilitiesOutput" class="output"></div>
    </div>

    <!-- Example 8: Advanced Promise Patterns -->
    <div class="example">
        <h3>8. Advanced Promise Patterns</h3>
        <p>This example demonstrates advanced Promise patterns and techniques.</p>
        
        <div class="code-block">
            <pre><code>// Advanced Promise patterns
class AdvancedPromises {
    // Promise pool for limiting concurrent operations
    static createPool(size) {
        const queue = [];
        let running = 0;
        
        return {
            async add(promiseFactory) {
                return new Promise((resolve, reject) => {
                    queue.push({ promiseFactory, resolve, reject });
                    this.process();
                });
            },
            
            async process() {
                if (running >= size || queue.length === 0) return;
                
                running++;
                const { promiseFactory, resolve, reject } = queue.shift();
                
                try {
                    const result = await promiseFactory();
                    resolve(result);
                } catch (error) {
                    reject(error);
                } finally {
                    running--;
                    this.process();
                }
            }
        };
    }
    
    // Promise cancellation
    static cancellable(promise) {
        let cancelled = false;
        
        const cancel = () => {
            cancelled = true;
        };
        
        const wrappedPromise = new Promise((resolve, reject) => {
            promise.then(
                result => cancelled ? reject(new Error('Cancelled')) : resolve(result),
                error => cancelled ? reject(new Error('Cancelled')) : reject(error)
            );
        });
        
        return { promise: wrappedPromise, cancel };
    }
    
    // Promise memoization
    static memoize(fn, ttl = 60000) {
        const cache = new Map();
        
        return function(...args) {
            const key = JSON.stringify(args);
            const cached = cache.get(key);
            
            if (cached && Date.now() - cached.timestamp < ttl) {
                return Promise.resolve(cached.value);
            }
            
            return fn.apply(this, args).then(result => {
                cache.set(key, { value: result, timestamp: Date.now() });
                return result;
            });
        };
    }
}</code></pre>
        </div>
        
        <button onclick="runAdvancedPromisePatterns()">Run Example</button>
        <div id="advancedPromisePatternsOutput" class="output"></div>
    </div>

    <script>
        // Example 1: Basic Promises
        function runBasicPromises() {
            const output = document.getElementById('basicPromisesOutput');
            output.innerHTML = '';
            
            const logs = [];
            const originalLog = console.log;
            console.log = (...args) => {
                logs.push(args.join(' '));
                originalLog(...args);
            };
            
            const promise = new Promise((resolve, reject) => {
                setTimeout(() => {
                    const success = Math.random() > 0.5;
                    if (success) {
                        resolve('Promise resolved successfully!');
                    } else {
                        reject(new Error('Promise rejected!'));
                    }
                }, 1000);
            });
            
            promise
                .then(result => console.log('Success:', result))
                .catch(error => console.log('Error:', error.message))
                .finally(() => console.log('Promise completed'));
            
            console.log = originalLog;
            
            setTimeout(() => {
                output.innerHTML = logs.join('<br>');
            }, 1500);
        }

        // Example 2: Promise Chaining
        function runPromiseChaining() {
            const output = document.getElementById('promiseChainingOutput');
            output.innerHTML = '';
            
            const logs = [];
            const originalLog = console.log;
            console.log = (...args) => {
                logs.push(args.join(' '));
                originalLog(...args);
            };
            
            function fetchUser(id) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({ id, name: `User ${id}`, email: `user${id}@example.com` });
                    }, 500);
                });
            }
            
            function fetchPosts(userId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve([
                            { id: 1, userId, title: 'Post 1' },
                            { id: 2, userId, title: 'Post 2' }
                        ]);
                    }, 300);
                });
            }
            
            function fetchComments(postId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve([
                            { id: 1, postId, text: 'Comment 1' },
                            { id: 2, postId, text: 'Comment 2' }
                        ]);
                    }, 200);
                });
            }
            
            fetchUser(1)
                .then(user => {
                    console.log('User:', user);
                    return fetchPosts(user.id);
                })
                .then(posts => {
                    console.log('Posts:', posts);
                    return fetchComments(posts[0].id);
                })
                .then(comments => {
                    console.log('Comments:', comments);
                })
                .catch(error => {
                    console.log('Error:', error.message);
                });
            
            console.log = originalLog;
            
            setTimeout(() => {
                output.innerHTML = logs.join('<br>');
            }, 1500);
        }

        // Example 3: Promise.all
        function runPromiseAll() {
            const output = document.getElementById('promiseAllOutput');
            output.innerHTML = '';
            
            const logs = [];
            const originalLog = console.log;
            console.log = (...args) => {
                logs.push(args.join(' '));
                originalLog(...args);
            };
            
            function fetchData(url) {
                return new Promise((resolve) => {
                    const delay = Math.random() * 2000 + 500;
                    setTimeout(() => {
                        resolve({ url, data: `Data from ${url}`, delay });
                    }, delay);
                });
            }
            
            const urls = [
                'https://api.example.com/users',
                'https://api.example.com/posts',
                'https://api.example.com/comments'
            ];
            
            Promise.all(urls.map(url => fetchData(url)))
                .then(results => {
                    console.log('All data fetched:', results);
                    console.log('Total time:', Math.max(...results.map(r => r.delay)));
                })
                .catch(error => {
                    console.log('Error:', error.message);
                });
            
            console.log = originalLog;
            
            setTimeout(() => {
                output.innerHTML = logs.join('<br>');
            }, 3000);
        }

        // Example 4: Promise.race
        function runPromiseRace() {
            const output = document.getElementById('promiseRaceOutput');
            output.innerHTML = '';
            
            const logs = [];
            const originalLog = console.log;
            console.log = (...args) => {
                logs.push(args.join(' '));
                originalLog(...args);
            };
            
            function timeoutPromise(ms) {
                return new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout')), ms);
                });
            }
            
            function fetchData(url) {
                return new Promise((resolve) => {
                    const delay = Math.random() * 2000 + 500;
                    setTimeout(() => {
                        resolve({ url, data: `Data from ${url}`, delay });
                    }, delay);
                });
            }
            
            function fetchWithTimeout(url, timeout = 2000) {
                return Promise.race([
                    fetchData(url),
                    timeoutPromise(timeout)
                ]);
            }
            
            const promises = [
                fetchWithTimeout('https://api.example.com/slow', 1000),
                fetchWithTimeout('https://api.example.com/fast', 2000),
                fetchWithTimeout('https://api.example.com/medium', 1500)
            ];
            
            Promise.race(promises)
                .then(result => {
                    console.log('First to complete:', result);
                })
                .catch(error => {
                    console.log('All failed or timeout:', error.message);
                });
            
            console.log = originalLog;
            
            setTimeout(() => {
                output.innerHTML = logs.join('<br>');
            }, 3000);
        }

        // Example 5: Promise.allSettled
        function runPromiseAllSettled() {
            const output = document.getElementById('promiseAllSettledOutput');
            output.innerHTML = '';
            
            const logs = [];
            const originalLog = console.log;
            console.log = (...args) => {
                logs.push(args.join(' '));
                originalLog(...args);
            };
            
            function fetchDataWithRandomFailure(url) {
                return new Promise((resolve, reject) => {
                    const delay = Math.random() * 1000 + 500;
                    setTimeout(() => {
                        if (Math.random() < 0.3) {
                            reject(new Error(`Failed to fetch ${url}`));
                        } else {
                            resolve({ url, data: `Data from ${url}` });
                        }
                    }, delay);
                });
            }
            
            const urls = [
                'https://api.example.com/users',
                'https://api.example.com/posts',
                'https://api.example.com/comments',
                'https://api.example.com/settings'
            ];
            
            Promise.allSettled(urls.map(url => fetchDataWithRandomFailure(url)))
                .then(results => {
                    console.log('All Promises settled:');
                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled') {
                            console.log(`✓ ${urls[index]}:`, result.value);
                        } else {
                            console.log(`✗ ${urls[index]}:`, result.reason.message);
                        }
                    });
                });
            
            console.log = originalLog;
            
            setTimeout(() => {
                output.innerHTML = logs.join('<br>');
            }, 2000);
        }

        // Example 6: Promise Error Handling
        function runPromiseErrorHandling() {
            const output = document.getElementById('promiseErrorHandlingOutput');
            output.innerHTML = '';
            
            const logs = [];
            const originalLog = console.log;
            console.log = (...args) => {
                logs.push(args.join(' '));
                originalLog(...args);
            };
            
            function fetchUserData(userId) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (userId < 0) {
                            reject(new Error('Invalid user ID'));
                        } else if (userId === 0) {
                            reject(new Error('User not found'));
                        } else {
                            resolve({ id: userId, name: `User ${userId}` });
                        }
                    }, 500);
                });
            }
            
            // Error handling with catch
            fetchUserData(1)
                .then(user => {
                    console.log('User found:', user);
                    return fetchUserData(user.id + 10);
                })
                .then(user => {
                    console.log('Related user:', user);
                })
                .catch(error => {
                    console.log('Error caught:', error.message);
                });
            
            // Error handling with individual catch
            fetchUserData(-1)
                .then(user => {
                    console.log('This will not execute');
                })
                .catch(error => {
                    console.log('Specific error:', error.message);
                    return { id: 0, name: 'Default User' };
                })
                .then(user => {
                    console.log('Fallback user:', user);
                });
            
            console.log = originalLog;
            
            setTimeout(() => {
                output.innerHTML = logs.join('<br>');
            }, 1500);
        }

        // Example 7: Promise Utilities
        function runPromiseUtilities() {
            const output = document.getElementById('promiseUtilitiesOutput');
            output.innerHTML = '';
            
            const logs = [];
            const originalLog = console.log;
            console.log = (...args) => {
                logs.push(args.join(' '));
                originalLog(...args);
            };
            
            class PromiseUtils {
                static delay(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                }
                
                static retry(fn, maxRetries = 3, delay = 1000) {
                    return new Promise((resolve, reject) => {
                        let attempts = 0;
                        
                        const attempt = () => {
                            attempts++;
                            fn()
                                .then(resolve)
                                .catch(error => {
                                    if (attempts < maxRetries) {
                                        console.log(`Attempt ${attempts} failed, retrying...`);
                                        setTimeout(attempt, delay * attempts);
                                    } else {
                                        reject(error);
                                    }
                                });
                        };
                        
                        attempt();
                    });
                }
                
                static timeout(promise, ms) {
                    return Promise.race([
                        promise,
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Operation timeout')), ms)
                        )
                    ]);
                }
            }
            
            // Test delay
            console.log('Testing delay...');
            PromiseUtils.delay(1000)
                .then(() => console.log('Delay completed'));
            
            // Test retry
            let retryAttempts = 0;
            const flakyFunction = () => {
                retryAttempts++;
                if (retryAttempts < 3) {
                    return Promise.reject(new Error('Temporary failure'));
                } else {
                    return Promise.resolve('Success after retries');
                }
            };
            
            PromiseUtils.retry(flakyFunction, 3, 500)
                .then(result => console.log('Retry result:', result))
                .catch(error => console.log('Retry failed:', error.message));
            
            console.log = originalLog;
            
            setTimeout(() => {
                output.innerHTML = logs.join('<br>');
            }, 3000);
        }

        // Example 8: Advanced Promise Patterns
        function runAdvancedPromisePatterns() {
            const output = document.getElementById('advancedPromisePatternsOutput');
            output.innerHTML = '';
            
            const logs = [];
            const originalLog = console.log;
            console.log = (...args) => {
                logs.push(args.join(' '));
                originalLog(...args);
            };
            
            // Promise pool example
            const pool = {
                queue: [],
                running: 0,
                size: 2,
                
                async add(promiseFactory) {
                    return new Promise((resolve, reject) => {
                        this.queue.push({ promiseFactory, resolve, reject });
                        this.process();
                    });
                },
                
                async process() {
                    if (this.running >= this.size || this.queue.length === 0) return;
                    
                    this.running++;
                    const { promiseFactory, resolve, reject } = this.queue.shift();
                    
                    try {
                        const result = await promiseFactory();
                        resolve(result);
                    } catch (error) {
                        reject(error);
                    } finally {
                        this.running--;
                        this.process();
                    }
                }
            };
            
            // Test promise pool
            for (let i = 0; i < 5; i++) {
                pool.add(() => {
                    return new Promise(resolve => {
                        const delay = Math.random() * 1000 + 500;
                        setTimeout(() => {
                            console.log(`Task ${i} completed after ${delay}ms`);
                            resolve(`Result ${i}`);
                        }, delay);
                    });
                });
            }
            
            console.log = originalLog;
            
            setTimeout(() => {
                output.innerHTML = logs.join('<br>');
            }, 3000);
        }
    </script>
</body>
</html>

